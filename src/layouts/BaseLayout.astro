---
import 'uno.css';
import '@/styles/global.css';
import ThemeToggle from '@/components/ui/ThemeToggle.astro';

const {
  title = 'Ubezpieczenia – szybko, prosto, bez haczyków',
  description = 'Porównujemy oferty 12 towarzystw i pomagamy wybrać najlepszą ochronę.',
  ogImage = '/images/hero.jpg'
} = Astro.props as { title?: string; description?: string; ogImage?: string };

const siteUrl = Astro.site ?? new URL('https://przyklad-ubezpieczenia.pl');
const canonical = new URL(Astro.url?.pathname ?? '/', siteUrl).toString();
---

<html lang="pl">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="generator" content={Astro.generator} />
    <meta name="description" content={description} />
    <link rel="canonical" href={canonical} />
    <title>{title}</title>

    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:image" content={new URL(ogImage, siteUrl).toString()} />
    <meta property="og:type" content="website" />
    <meta name="theme-color" content="#ffffff" />

    <link rel="icon" href="/favicon.svg" type="image/svg+xml" />
    <link rel="icon" href="/favicon.ico" sizes="any" />
    <link rel="apple-touch-icon" href="/apple-touch-icon.png" sizes="180x180" />
    <link rel="manifest" href="/manifest.webmanifest" />

    <!-- anti-FOUC: ustaw motyw przed malowaniem -->
    <script is:inline>
      (function() {
        try {
          const saved = localStorage.getItem('theme');
          const preferDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
          document.documentElement.dataset.theme = saved || (preferDark ? 'dark' : 'light');
        } catch {}
      })();
    </script>

<style is:global>
  .site-header[data-scrolled='true'] { box-shadow: var(--shadow-2); background: var(--header-bg-scrolled); backdrop-filter: blur(6px); }
  .mobile-nav[hidden] { display: none; }
</style>

    {import.meta.env.CF_WEB_ANALYTICS_TOKEN && (
      <script defer src="https://static.cloudflareinsights.com/beacon.min.js" data-cf-beacon={`{"token": "${import.meta.env.CF_WEB_ANALYTICS_TOKEN}"}`} />
    )}

    <!-- JSON-LD Organization + WebSite -->
    <script type="application/ld+json">
      {JSON.stringify({
        '@context':'https://schema.org',
        '@type':'Organization',
        name:'TwojeUbezpieczenia',
        url: siteUrl.toString(),
        logo: new URL('/images/logo.svg', siteUrl).toString(),
        sameAs:[]
      })}
    </script>
    <script type="application/ld+json">
      {JSON.stringify({
        '@context':'https://schema.org',
        '@type':'WebSite',
        name:'TwojeUbezpieczenia',
        url: siteUrl.toString(),
        potentialAction:{
          '@type':'SearchAction',
          target: `${siteUrl.toString().replace(/\/$/,'')}/blog?search={search_term_string}`,
          'query-input':'required name=search_term_string'
        }
      })}
    </script>
  </head>
  <body>
    <header class="site-header sticky top-0 z-50 border-b border-[var(--surface-2)] bg-[var(--header-bg)] backdrop-blur">
      <nav class="container flex items-center justify-between py-3" aria-label="Główna nawigacja">
        <a href="/" class="flex items-center gap-2 ring-focus" aria-label="Strona główna">
          <img src="/images/logo.svg" alt="TwojeUbezpieczenia – logo" width="28" height="28" decoding="async" fetchpriority="high" />
          <span class="font-semibold">TwojeUbezpieczenia</span>
        </a>

        <!-- Desktop -->
        <div class="hidden md:flex items-center gap-2">
          <ul class="flex items-center gap-2">
            <li><a class="btn-ghost tap-target" href="/#oferta">Oferta</a></li>
            <li><a class="btn-ghost tap-target" href="/#o-nas">O nas</a></li>
            <li><a class="btn-ghost tap-target" href="/blog">Blog</a></li>
            <li><a class="btn tap-target" href="/#kontakt" aria-label="Uzyskaj wycenę">Uzyskaj wycenę</a></li>
          </ul>
          <ThemeToggle />
        </div>

        <!-- Mobile toggle -->
        <button id="menu-toggle" class="icon-btn md:hidden" aria-label="Otwórz menu" aria-expanded="false" aria-controls="mobile-menu">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none"><path d="M4 7h16M4 12h16M4 17h16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
        </button>
      </nav>

      <!-- Off-canvas mobile menu -->
      <div id="mobile-overlay" class="overlay md:hidden mobile-nav" hidden></div>
      <nav id="mobile-menu" class="drawer md:hidden mobile-nav" aria-label="Menu mobilne" hidden>
        <div class="flex items-center justify-between mb-4">
          <strong>Menu</strong>
          <div class="flex items-center gap-2">
            <ThemeToggle />
            <button id="menu-close" class="icon-btn" aria-label="Zamknij menu">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none"><path d="M6 6l12 12M18 6L6 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
            </button>
          </div>
        </div>
        <ul class="space-y-1">
          <li><a class="btn-ghost tap-target w-full" href="/#oferta">Oferta</a></li>
          <li><a class="btn-ghost tap-target w-full" href="/#o-nas">O nas</a></li>
          <li><a class="btn-ghost tap-target w-full" href="/blog">Blog</a></li>
          <li><a class="btn tap-target w-full justify-center" href="/#kontakt">Uzyskaj wycenę</a></li>
        </ul>
      </nav>

      <script is:inline>
        // Sticky header
        const header = document.querySelector('.site-header');
        const onScroll = () => header && header.setAttribute('data-scrolled', String(window.scrollY > 4));
        onScroll(); window.addEventListener('scroll', onScroll, { passive: true });

        // Drawer (płynny)
        const toggleBtn = document.getElementById('menu-toggle');
        const closeBtn  = document.getElementById('menu-close');
        const menu = document.getElementById('mobile-menu');
        const overlay = document.getElementById('mobile-overlay');

        const openDrawer = (open) => {
          if (!menu || !overlay) return;
          if (open) {
            menu.hidden = overlay.hidden = false;
            requestAnimationFrame(() => { menu.classList.add('open'); overlay.classList.add('open'); });
            toggleBtn?.setAttribute('aria-expanded', 'true');
            document.body.style.overflow = 'hidden';
          } else {
            menu.classList.remove('open'); overlay.classList.remove('open');
            const after = () => { menu.hidden = overlay.hidden = true; };
            menu.addEventListener('transitionend', after, { once: true });
            toggleBtn?.setAttribute('aria-expanded', 'false');
            document.body.style.overflow = '';
          }
        };
        toggleBtn?.addEventListener('click', () => openDrawer(menu?.hidden));
        closeBtn?.addEventListener('click', () => openDrawer(false));
        overlay?.addEventListener('click', () => openDrawer(false));
        window.addEventListener('keydown', (e) => { if (e.key === 'Escape') openDrawer(false); });

        // Scroll-reveal
        const prefersReduce = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
        const revealEls = Array.from(document.querySelectorAll('[data-reveal]'));
        if (prefersReduce) {
          revealEls.forEach(el => el.classList.add('is-visible'));
        } else if (revealEls.length) {
          const io = new IntersectionObserver((entries) => {
            entries.forEach(e => { if (e.isIntersecting) { e.target.classList.add('is-visible'); io.unobserve(e.target); } });
          }, { rootMargin: '0px 0px -10% 0px', threshold: 0.1 });
          revealEls.forEach(el => io.observe(el));
        }
      </script>
    </header>

    <main><slot /></main>

    <footer class="mt-16 border-t border-[var(--surface-2)]">
      <div class="container py-10 grid gap-8 md:grid-cols-3">
        <div>
          <div class="flex items-center gap-2 mb-2">
            <img src="/images/logo.svg" alt="" width="24" height="24" />
            <strong>TwojeUbezpieczenia</strong>
          </div>
          <p class="muted">Bezpiecznie. Transparentnie. Po ludzku.</p>
        </div>
        <div>
          <div class="eyebrow mb-2">Szybkie linki</div>
          <ul class="space-y-1">
            <li><a href="/blog">Blog</a></li>
            <li><a href="/#kontakt">Kontakt</a></li>
            <li><a href="#">Polityka prywatności</a></li>
          </ul>
        </div>
        <div>
          <div class="eyebrow mb-2">Dane</div>
          <p>tel. 123 456 789<br />biuro@twojeubezpieczenia.pl</p>
        </div>
      </div>
      <div class="py-4 text-center text-sm muted">© {new Date().getFullYear()} TwojeUbezpieczenia</div>
    </footer>

    {!import.meta.env.DEV && <link rel="stylesheet" href="/_pagefind/pagefind-ui.css" />}
  </body>
</html>
